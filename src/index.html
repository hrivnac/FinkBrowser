<html>

<head>
<title>Fink Browser</title>
</head>

<body>

<table><tr>
<td><img src="Fink.png" width="100"/></td>
<td><h1>Fink Browser</h1>
<h4>@VERSION@ [@BUILD@]</h3>
</tr></table>
<hr/>

<h2><a href="http://134.158.74.221:8080/FinkBrowser/?profile=ijclab&style=simple">Prototype running @IJCLab</a> (under development)</h2>
<h2><a href="https://docs.google.com/presentation/d/1UYgqtNFuKWPObPGT4O81EOTkQ7F5_BaOiBp34Dw3yWk/edit?usp=sharing">What is it ?</a> (presentation)</h2>
<hr/>

<h2>Documentation</h2>

<ul>
<li><a href="JavaDoc">JavaDoc</a></li>
<li><a href="Src">Source</a></li>
<li><a href="build.jpg">Ant build dependencies</a></li>
<li><a href="index.jpg">Class diagram</a></li>
<li><a href="https://github.com/hrivnac/FinkBrowser.git">https://github.com/hrivnac/FinkBrowser.git</a></li>
<li>Externals:
    <a href="https://www.java.com">Java</a>,
    <a href="https://cern.ch/hrivnac/Activities/Packages/Lomikel">Lomikel</a> (and others used by it),
    <a href="http://www.jython.org">Jython</a> (for Jython client, optional),
    <a href="http://www.jpype.org">JPype</a> (for CPython client, optional),
    <a href="http://sagemath.org">Sage</a> (to perform math analyses, optional),
    <a href="http://matplotlib.org">MatPlotLib</a> (to perform math analyses, optional)</li>
<li>Tools:
    <a href="https://ant.apache.org">Ant</a>,
    <a href="http://www.java2html.com">J2H</a>,
    <a href="http://vizant.sourceforge.net">Vizant</a>,
    <a href="https://github.com/dspinellis/UMLGraph">UmlGraph</a>,
    <a href="http://findbugs.sourceforge.net">FindBugs</a>,
    CleanImports,
    <a href="https://code.google.com/archive/p/apiviz">ApiViz</a>,
    <a href="https://github.com/clarkware/jdepend">JDepend</a></li>
</ul>
<hr/>

<h2><a name="Graph">Graph Schema</a></h2>
Initial Graph contains:
<pre>
AstroLabNet -has&gt; site -holds&gt; AlertsCollection -contains&gt; alert
similarity -satr&gt; alert
alert -exactmatch&gt; alert
</pre>
<hr/>

<h2><a name="WebService">Web Service</a></h2>
<table>
<tr><td><a href="FinkBrowser.jpg" ><img src="FinkBrowser.jpg"  width="600"></a></td></tr>
<tr><td><a href="FinkBrowser1.jpg"><img src="FinkBrowser1.jpg" width="600"></a></td></tr>
<tr><td><a href="FinkBrowser2.jpg"><img src="FinkBrowser2.jpg" width="600"></a></td></tr>
</table>
<b><u>Customisation</u></b>
<ul>
<li><tt>Servers-&lt;target&gt;.jsp</tt> contains the list of <em>Gremlin</em> servets</li>
<li><tt>Graphs-&lt;target&gt;.jsp</tt> contains the list of initial graphs, formed as <em>Gremlin</em> queries</li>
<li><tt>bootgreamlin</tt> property contains the specific <em>Gremlin</em> query</li>
</ul>
<b><u>Options</u></b>
<ul>
<li><tt>profile</tt> for initial calls (<tt>null, test, local, ijclab</tt>)</li>
<li><tt>style</tt> for pane setup (<tt>null, test, simple</tt>)</li>
</ul>
<hr/>

<h2><a name="CLI">Command Line</a></h2>
Command line (executable Java) can be downloaded from the repository:
<a href="http://cern.ch/hrivnac/Activities/Packages/FinkBrowser.exe.jar">FinkBrowser.exe.jar</a>.
It serves as a foundation for all clients.
<pre style="color:blue; font-size:60%; background-color:#eeeeee">
$ java -jar FinkBrowser.exe.jar -h
usage: java -jar Lomikel.exe.jar
 -b,--batch           run in a batch
 -g,--gui             run in a graphical window
 -h,--help            show help
 -q,--quiet           minimal direct feedback
 -s,--source &lt;file&gt;   source bsh file (init.bsh is also read)
</pre>
It allows <a href="https://beanshell.github.io">BeanShell</a>/Java scripting, with Python and <a href="http://sagemath.org">SageMath</a> interface. 
<br/>
<h3>Access to HBase</h3>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/bsh/testHBaseClient.bsh">BeanShell/Java example</a>:</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
// Connect to HBase table
//HBaseClient client = new HBaseClient("localhost", 2181);
HBaseClient client = new HBaseClient("134.158.74.54", 2181);
client.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6");
client.setLimit(100);

// Get two known alerts (two columns) 
results = client.scan("ZTF17aaaaxyd_2458789.0426273,ZTF17aaaajdq_2458789.0297801",
                      null,
                      "i:candid,b:cutoutScience_stampData",
                      0,
                      false,
                      false);
print(client.results2String(results)); 

// Get binary cell
print(client.repository().get("binary:ZTF17aaaaxyd_2458789.0426273:cutoutScience_stampData"));


// Get all alerts with row containing 'xyd' or starting with 'ZTF19aaaiw'
// Available comparators: exact, prefix (default), substring, regex
results = client.scan(null,
                      "key:key:xyd:substring,key:key:ZTF19aaaiw:prefix",
                      "i:candid",
                      0,
                      true,
                      true);
print(client.results2String(results)); 

// Get all alerts with column match
// It only works for string columns, use Evaluator for numerical columns
// Available comparators: exact, prefix, substring (default), regex
results = client.scan(null,
                      "d:cdsxmatch:YSO:exact",
                      "i:candid,d:cdsxmatch",
                      0,
                      true,
                      true);
print(client.results2String(results)); 

// Get timeline dependece of i:dec
results = client.timeline("i:dec");
print(client.results2String(results)); 

// Get all recent (last 100000 minutes) objectIds
results = client.latests("i:objectId",
                         null,
                         100000,
                         true);
print(results); 

// Apply predefined function to filter results
client.setEvaluation("isWithinGeoLimits(80, 85, -4.0, 0.0)", "ra,dec");
results = client.scan(null,
                      null,
                      null,
                      0,
                      false,
                      false);
print(client.results2String(results)); 

// Apply formula to filter results
client.setEvaluation("dec < 10");
results = client.scan(null,
                      null,
                      null,
                      0,
                      false,
                      false);
print(client.results2String(results)); 

client.close();
</pre>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/python/testHBaseClient.jy">Jython example</a> (needs <a href="http://www.jython.org">Jython</a>):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
import sys

# ../dist/FinkBrowser.exe.jar
sys.path.append(sys.argv[1])

from com.Lomikel.HBaser import HBaseClient

#client = HBaseClient("localhost", 2181)
client = HBaseClient("134.158.74.54", 2181);
client.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6")
client.setLimit(10)

print(client.scan(None, "key:key:ZTF17", None, 100000, True, True))

client.close()
</pre>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/python/testHBaseClient.py">CPython example</a> (needs <a href="http://www.jpype.org">JPype</a>):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
import sys

import jpype
import jpype.imports
from jpype import JImplements, JOverride, JImplementationFor

# ../dist/FinkBrowser.exe.jar
jpype.startJVM(jpype.getDefaultJVMPath(), "-ea", "-Djava.class.path=" + sys.argv[1], convertStrings=False)

from com.Lomikel.HBaser import HBaseClient

true  = jpype.java.lang.Boolean(True)
false = jpype.java.lang.Boolean(False)

#client = HBaseClient("localhost", 2181)
client = HBaseClient("134.158.74.54", 2181);
client.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6")
client.setLimit(10)

print(client.scan(None, "key:key:ZTF17", None, 100000, true, true)) 

client.close()

jpype.shutdownJVM()
</pre>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/python/testHBaseClient.sage">Sage example</a> (needs also <a href="http://sagemath.org">SageMath</a>):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
import sys

import jpype
import jpype.imports
from jpype import JImplements, JOverride, JImplementationFor

jpype.startJVM(jpype.getDefaultJVMPath(), "-ea", "-Djava.class.path=../dist/FinkBrowser.exe.jar", convertStrings=True)

import java.lang
import java.util

import com.Lomikel.HBaser

true  = jpype.java.lang.Boolean(True)
false = jpype.java.lang.Boolean(False)

client = com.Lomikel.HBaser.HBaseClient("localhost", 2181)
client.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6")
#client.setLimit(10);

a17 = [];
a19 = [];
for r in client.scan("", "key:key:ZTF17", "i:ra,i:dec", 100000, false, false).values():
  a17 += [(float(r['i:ra']), float(r['i:dec']))];
for r in client.scan("", "key:key:ZTF19", "i:ra,i:dec", 100000, false, false).values():
  a19 += [(float(r['i:ra']), float(r['i:dec']))];
p = list_plot(a17, color='red') + list_plot(a19, color='blue');
show(p, axes_labels = ('ra', 'dec'), title='ZTF17(red) + ZTF19(blue)');

client.close();

jpype.shutdownJVM()
</pre>
<a href="SageExample.jpg" ><img src="SageExample.jpg"  width="400"></a><br/>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/python/testHBaseClient_matplotlib.py">CPython example with graphics</a> (needs also <a href="http://matplotlib.org">MatPlotLib</a>):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
import sys

import jpype
import jpype.imports
from jpype import JImplements, JOverride, JImplementationFor

import matplotlib.pyplot as plt

# ../dist/FinkBrowser.exe.jar
jpype.startJVM(jpype.getDefaultJVMPath(), "-ea", "-Djava.class.path=" + sys.argv[1], convertStrings=True)

from com.Lomikel.HBaser import HBaseClient

true  = jpype.java.lang.Boolean(True)
false = jpype.java.lang.Boolean(False)

#client = HBaseClient("localhost", 2181)
client = HBaseClient("134.158.74.54", 2181);
client.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6")
#client.setLimit(10)

a17_x = [];
a17_y = [];
a19_x = [];
a19_y = [];
for r in client.scan("", "key:key:ZTF17", "i:ra,i:dec", 0, false, false).values():
  a17_x += [float(r['i:ra'])]
  a17_y += [float(r['i:dec'])]
for r in client.scan("", "key:key:ZTF19", "i:ra,i:dec", 0, false, false).values():
  a19_x += [float(r['i:ra'])]
  a19_y += [float(r['i:dec'])]

plt.plot(a17_x, a17_y, 'r.')
plt.plot(a19_x, a19_y, 'b.')
plt.title('ZTF17(red) + ZTF19(blue)')
plt.xlabel('ra')
plt.ylabel('dec')
plt.show()

client.close()

jpype.shutdownJVM()
</pre>
<a href="MatplotlibExample.jpg" ><img src="MatplotlibExample.jpg"  width="400"></a>
<h3>Access to JanusGraph</h3>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/bsh/testGremlinClient.bsh">BeanShell/Java example</a>:</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
// Connect to JanusGraph
GremlinClient client = new GremlinClient("134.158.74.85", 24444);
g = client.g();

// Get properties of the first alert
print(g.V().hasLabel('alert').limit(1).valueMap().next());

client.close();
</pre>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/python/testGremlinClient.jy">Jython example</a> (needs <a href="http://www.jython.org">Jython</a>):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
import sys

# ../dist/FinkBrowser.exe.jar
sys.path.append(sys.argv[1])

from com.Lomikel.Januser import GremlinClient

client = GremlinClient("134.158.74.85", 24444);

g = client.g();
print(g.V().hasLabel('alert').limit(1).valueMap().next());

client.close()
</pre>
<u><b><a href="https://github.com/hrivnac/FinkBrowser/blob/master/src/bsh/testClients.bsh">Full example, connecting to both databases</a> (Java version):</b></u>
<pre style="color:blue; font-size:60%; background-color:#dddddd">
// Connect to JanusGraph
GremlinClient gc = new GremlinClient("134.158.74.85", 24444);
g = gc.g();

// Connect to HBase
HBaseClient hc = new HBaseClient("134.158.74.54", 2181);
hc.connect("test_portal_tiny.3", "schema_0.7.0_0.3.6");

// Get new interesting alerts from JanusGraph
// 1) get AlertCollection with name = NewInterestingAlerts
// 2) navigate all outgoing edges to get all alerts in this collection
// 3) convert their rowkeys into a List
rowkeys = g.V().has("AlertCollection", "name", "NewInterestingAlerts").out().values("rowkey").toList();

// Get dec*ra for those alerts from HBase
// 1) convert the List of rowkeys into a String with a comma-separated list of them
// 2) ask HBase for dec and ra properties of those alerts 
keysearch = String.join(",", rowkeys);
results = hc.scan(keysearch,
                  null,
                  "i:dec,i:ra",
                  0,
                  false,
                  false);

// Analyse them
// ...

// Close connections
gc.close();
hc.close();
</pre>
<hr/>

<h2><a name="Bugs-ToDos">Bugs, Inconsistencies and ToDos</a></h2>
<b><u>Bugs</u></b>
<ul>
<li>...</li>
</ul>
<b><u>Inconsistencies</u></b>
<ul>
<li>...</li>
</ul>
<b><u>ToDos</u></b>
<ul>
<li>...</li>
</ul>
<hr/>

<h2><a name="Releases">Release History</a></h2>
<ul>
<li><u>00.01.00:</u>
    <ul>
    <li>Initial release.</li>
    </ul></li>
<li><u>00.01.00:</u>
    <ul>
    <li>Usable, based on JHtools 00.04.00.</li>
    </ul></li>
<li><u>00.02.00:</u>
    <ul>
    <li>REST HBase connection.</li>
    </ul></li>
<li><u>00.03.00:</u>
    <ul>
    <li>Direct HBase connection.</li>
    <li>Latest alerts with expansion.</li>
    <li>CLI.</li>
    </ul></li>
<li><u>00.04.00:</u>
    <ul>
    <li>Better CLI,GUI.</li>
    <li>Faster HBase.</li>
    </ul></li>
<li><u>00.05.00:</u>
    <ul>
    <li>Callable from Python.</li>
    <li>Callable from Sage Math.</li>
    </ul></li>
<li><u>00.05.02:</u>
    <ul>
    <li>Better WS.</li>
    <li>Link from HBase table to Graph.</li>
    </ul></li>
<li><u>*.*.*:</u>
    <ul>
    <li>Included Gremlin client.</li>
    </ul></li>
</ul>
<hr/>

<h2>Related Documentation</h2>
<ul>
<li><a href="http://cern.ch/hrivnac/Activities/Packages/Lomikel">Lomikel</a></li>
</ul>
<hr/>

<h4><a name="Presentations">Presentations</a></h4>
<ul>
<li><u>2020:</u>
    <ul>
    <li><a href="https://hrivnac.web.cern.ch/hrivnac/Activities/2020/October/FinkBrowser">Fink Browser</a> (LSST, IJCLab, October'20)</li>
    </ul></li>
</ul>
</p>
<hr/>

<img width="0" height="0" src="http://cern.ch/hrivnac/cgi-bin/record.pl?page=FinkBrowser"> 
<address>
<a href="http://cern.ch/hrivnac">J.Hrivnac</a> @BUILD@
</address>
</body>
</html>
